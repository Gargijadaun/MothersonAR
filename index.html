<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AR Video Placement</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script>
      AFRAME.registerComponent("ar-hit-place", {
        init: function () {
          this.viewerSpace = null;
          this.refSpace = null;
          this.hitTestSource = null;
          this.hasPlaced = false;

          const scene = this.el.sceneEl;

          scene.renderer.xr.addEventListener("sessionstart", () => {
            const session = scene.renderer.xr.getSession();

            session.requestReferenceSpace("viewer").then((space) => {
              this.viewerSpace = space;
              session.requestHitTestSource({ space }).then((source) => {
                this.hitTestSource = source;
              });
            });

            session.requestReferenceSpace("local-floor").then((space) => {
              this.refSpace = space;
            });

            session.addEventListener("select", () => {
              if (!this.latestHit || this.hasPlaced) return;

              const pos = this.latestHit;
              const videoPlane = document.getElementById("videoPlane");

              videoPlane.setAttribute("position", pos);
              videoPlane.setAttribute("visible", true);
              document.getElementById("video").play();
              this.hasPlaced = true;
            });
          });
        },

        tick: function () {
          if (!this.viewerSpace || !this.refSpace || !this.hitTestSource) return;
          const frame = this.el.sceneEl.frame;
          const hitTestResults = frame.getHitTestResults(this.hitTestSource);

          if (hitTestResults.length > 0) {
            const referenceSpace = this.refSpace;
            const hitPose = hitTestResults[0].getPose(referenceSpace);
            this.latestHit = {
              x: hitPose.transform.position.x,
              y: hitPose.transform.position.y,
              z: hitPose.transform.position.z,
            };
          }
        },
      });

      function changeVideo(src) {
        const video = document.getElementById("video");
        const videoPlane = document.getElementById("videoPlane");

        video.pause();
        video.src = src;
        video.load();
        video.oncanplay = () => {
          video.play();
          videoPlane.setAttribute("material", "src", "#video");
        };
      }
    </script>
  </head>

  <body style="margin: 0; overflow: hidden">
    <a-scene
      vr-mode-ui="enabled: false"
      webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay"
      xr-dom-overlay="root: #overlay"
      embedded
    >
      <a-camera
        position="0 0 0"
        look-controls="enabled: true"
        cursor="fuse: false; rayOrigin: mouse"
        raycaster="objects: .clickable"
      ></a-camera>

      <!-- Video plane -->
      <a-plane
        id="videoPlane"
        width="1.6"
        height="0.9"
        visible="false"
        material="shader: flat; src: #video"
      ></a-plane>

      <!-- Hit test component -->
      <a-entity ar-hit-place></a-entity>
    </a-scene>

    <!-- Video asset -->
    <video
      id="video"
      loop
      crossorigin="anonymous"
      webkit-playsinline
      playsinline
      style="display: none"
    >
      <source src="./video/Video1.mp4" type="video/mp4" />
    </video>

    <!-- UI Overlay -->
    <div
      id="overlay"
      style="
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 999;
        display: flex;
        gap: 10px;
      "
    >
      <button onclick="changeVideo('./video/Video1.mp4')">Video 1</button>
      <button onclick="changeVideo('./video/Video2.mp4')">Video 2</button>
      <button onclick="changeVideo('./video/Video3.mp4')">Video 3</button>
    </div>
  </body>
</html>
